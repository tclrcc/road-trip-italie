<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <title>Ma Valise - RoadTrip</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/font-awesome.min.css}" rel="stylesheet">
    <style>
        .packed-true { text-decoration: line-through; color: #aaa; }
        .category-header { background-color: #f8f9fa; border-left: 5px solid #0d6efd; }
    </style>
</head>
<body class="bg-light">

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ðŸŽ’ Ma Valise Intelligente</h1>
        <a th:href="@{/}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> Retour</a>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title">Ajouter un objet</h5>
            <form th:action="@{/packing/add}" method="post" th:object="${newItem}" class="row g-2 align-items-center">
                <div class="col-md-4">
                    <input type="text" th:field="*{name}" class="form-control" placeholder="Ex: CrÃ¨me solaire" required>
                </div>
                <div class="col-md-3">
                    <select th:field="*{category}" class="form-select">
                        <option th:each="cat : ${categories}" th:value="${cat}" th:text="${cat.label}"></option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select th:field="*{assignedTo}" class="form-select">
                        <option value="Commun">Commun</option>
                        <option value="Tony">Tony</option>
                        <option value="Copine">Copine</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" th:field="*{essential}" id="isEssential">
                        <label class="form-check-label text-danger fw-bold" for="isEssential">Vital ?</label>
                    </div>
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-plus"></i></button>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3" th:each="entry : ${itemsByCategory}">
            <div class="card h-100">
                <div class="card-header category-header fw-bold" th:text="${entry.key.label}"></div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center"
                        th:each="item : ${entry.value}">

                        <div class="form-check">
                            <input class="form-check-input packing-checkbox" type="checkbox"
                                   th:data-id="${item.id}"
                                   th:checked="${item.packed}">
                            <label class="form-check-label"
                                   th:classappend="${item.packed} ? 'packed-true' : ''"
                                   th:text="${item.name}"></label>

                            <span th:if="${item.essential}" class="badge bg-danger ms-1" title="Indispensable">!</span>
                            <span class="badge bg-light text-dark border ms-1" th:text="${item.assignedTo}"></span>
                        </div>

                        <a th:href="@{'/packing/delete/' + ${item.id}}" class="text-danger btn-sm">
                            <i class="fas fa-times"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // Script JS pur pour gÃ©rer le click sans recharger la page
    document.querySelectorAll('.packing-checkbox').forEach(box => {
        box.addEventListener('change', function() {
            const id = this.getAttribute('data-id');
            const label = this.nextElementSibling;

            // Appel AJAX
            fetch('/packing/toggle/' + id, { method: 'POST' })
                .then(response => {
                    if(response.ok) {
                        // Mise Ã  jour visuelle immÃ©diate
                        if(this.checked) {
                            label.classList.add('packed-true');
                        } else {
                            label.classList.remove('packed-true');
                        }
                    } else {
                        alert("Erreur de connexion serveur");
                        this.checked = !this.checked; // Annuler le check visuel
                    }
                });
        });
    });
</script>

</body>
</html>
