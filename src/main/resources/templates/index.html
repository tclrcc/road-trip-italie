<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <title>Road Trip Italie 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/leaflet.css}" rel="stylesheet">
    <link th:href="@{/css/font-awesome.min.css}" rel="stylesheet">
    <link th:href="@{/css/index.css}" rel="stylesheet">
</head>
<body>

<div class="hero-section text-center shadow-sm">
    <div class="container position-relative">
        <div class="position-absolute top-0 end-0 m-3 d-flex gap-2">
            <a th:href="@{/packing}" class="btn btn-sm btn-light text-primary fw-bold shadow-sm">
                <i class="fas fa-suitcase"></i> Valise
            </a>
            <form th:action="@{/logout}" method="post">
                <button type="submit" class="btn btn-sm btn-outline-light">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </form>
        </div>

        <h1 class="display-6 fw-bold mb-1"><i class="fas fa-road"></i> Italia 2026</h1>
        <p class="opacity-75 mb-3">
            <span th:text="${duration}"></span> jours de Dolce Vita avec <span th:text="${#authentication.name}">Toi</span>
        </p>

        <div th:if="${daysBeforeStart > 0}" class="d-inline-block bg-white text-primary px-3 py-1 rounded-pill fw-bold shadow-sm">
            üöÄ D√©part dans <span th:text="${daysBeforeStart}"></span> jours
        </div>
        <div th:unless="${daysBeforeStart > 0}" class="d-inline-block bg-warning text-dark px-3 py-1 rounded-pill fw-bold shadow-sm">
            üçï Andiamo !
        </div>
    </div>
</div>

<div class="container">

    <div class="row mb-4 justify-content-center">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-end mb-1">
                        <small class="text-muted fw-bold">BUDGET ESTIM√â</small>
                        <span class="fw-bold text-dark"><span th:text="${#numbers.formatDecimal(totalBudget, 0, 0)}"></span> ‚Ç¨</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             th:style="'width: ' + ${(paidAmount / totalBudget) * 100} + '%'"
                             title="Pay√©"></div>
                        <div class="progress-bar bg-warning" role="progressbar"
                             th:style="'width: ' + ${(remainingToPay / totalBudget) * 100} + '%'"
                             title="√Ä payer"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small class="text-success"><i class="fas fa-check-circle"></i> Pay√©: <span th:text="${#numbers.formatDecimal(paidAmount, 0, 0)}"></span>‚Ç¨</small>
                        <small class="text-warning"><i class="fas fa-exclamation-circle"></i> Reste: <span th:text="${#numbers.formatDecimal(remainingToPay, 0, 0)}"></span>‚Ç¨</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-5 overflow-hidden rounded-4">
        <div id="map" style="height: 300px;"></div>
    </div>

    <h4 class="mb-4 fw-bold text-secondary"><i class="fas fa-calendar-alt me-2"></i>L'Aventure Jour par Jour</h4>

    <div class="timeline">

        <div th:each="day : ${days}" class="timeline-item">

            <div class="text-center weather-widget"
                 th:if="${weatherMap.get(day.id) != null}"
                 th:with="w=${weatherMap.get(day.id)}">

                <i th:class="${w.iconClass} + ' fa-lg mb-1'"></i>

                <div class="fw-bold" style="font-size: 0.8rem;">
                    <span th:text="${#numbers.formatDecimal(w.maxTemp, 1, 0)}">25</span>¬∞
                </div>

                <small th:unless="${w.isRealForecast}" class="text-muted d-block" style="font-size: 0.6rem; transform: scale(0.8);" title="Moyenne de saison (Pr√©vision non dispo)">
                    (Est.)
                </small>
            </div>

            <div class="text-center text-muted opacity-25" th:unless="${weatherMap.get(day.id) != null}">
                <i class="fas fa-minus"></i>
            </div>

            <div class="timeline-dot" th:classappend="${day.warningZTL} ? 'ztl-alert' : ''"></div>

            <div class="timeline-content position-relative"
                 th:classappend="${day.warningZTL} ? 'is-ztl' : 'is-hub'">

                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <span class="timeline-date" th:text="${#temporals.format(day.date, 'EEEE d MMMM')}">Lundi 1 Mai</span>
                        <h5 class="timeline-title" th:text="${day.title}">Titre de l'√©tape</h5>
                    </div>

                    <div class="text-center text-muted opacity-50">
                        <i class="fas fa-sun fa-lg text-warning"></i>
                        <div style="font-size: 0.7rem;">24¬∞</div>
                    </div>
                </div>

                <p class="text-secondary mb-3" th:text="${day.mainActivity}"></p>

                <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                    <span class="badge bg-light text-dark border">
                        <i class="fas fa-home text-primary"></i> <span th:text="${day.hubLocation}"></span>
                    </span>
                    <span class="badge bg-light text-dark border">
                        <i class="fas fa-coins text-success"></i> ~<span th:text="${day.dailyBudget}"></span>‚Ç¨
                    </span>
                    <span th:if="${day.warningZTL}" class="badge badge-ztl shadow-sm">
                        <i class="fas fa-ban"></i> ATTENTION ZTL
                    </span>
                </div>

                <div th:if="${day.logisticsTip != null && !day.logisticsTip.isEmpty()}" class="logistics-box">
                    <i class="fas fa-info-circle me-1"></i> <span th:text="${day.logisticsTip}"></span>
                </div>

                <div class="mt-3 pt-3 border-top d-flex justify-content-between align-items-center">
                    <a th:href="${day.accommodation != null} ?
                            'https://www.google.com/maps/search/?api=1&query=' + ${day.accommodation.latitude} + ',' + ${day.accommodation.longitude} :
                            'https://www.google.com/maps/search/?api=1&query=' + ${day.hubLocation}"
                       target="_blank"
                       class="btn btn-sm btn-outline-primary rounded-pill px-3">
                        <i class="fas fa-location-arrow me-1"></i> Y aller
                    </a>

                    <a th:if="${day.accommodation != null && day.accommodation.airbnbLink != null}"
                       th:href="${day.accommodation.airbnbLink}" target="_blank"
                       class="btn btn-sm btn-link text-decoration-none text-danger">
                        <i class="fab fa-airbnb fa-lg"></i>
                    </a>
                </div>

            </div>
        </div>

    </div> <div class="d-grid gap-2 mt-5 mb-5">
    <button class="btn btn-light border text-secondary py-3" type="button" data-bs-toggle="collapse" data-bs-target="#docsCollapse">
        <i class="fas fa-folder-open me-2"></i> Voir mes Documents de Voyage (<span th:text="${documents.size()}">0</span>)
    </button>
</div>

    <div class="collapse mb-5" id="docsCollapse">
        <div class="card card-body bg-light border-0">
            <form method="POST" th:action="@{/uploadDoc}" enctype="multipart/form-data" class="d-flex gap-2 mb-3">
                <input type="file" name="file" class="form-control form-control-sm" required>
                <button type="submit" class="btn btn-sm btn-primary">Ajouter</button>
            </form>
            <div class="list-group">
                <div th:each="doc : ${documents}" class="list-group-item d-flex justify-content-between align-items-center">
                    <a th:href="@{'/document/' + ${doc.id}}" target="_blank" class="text-decoration-none text-dark text-truncate" style="max-width: 80%;">
                        <i class="fas fa-file-alt text-primary me-2"></i> <span th:text="${doc.name}"></span>
                    </a>
                    <a th:href="@{'/deleteDoc/' + ${doc.id}}" class="text-danger small" onclick="return confirm('Supprimer ?')">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center text-muted small py-4">
        RoadTrip App &copy; 2026 - Con√ßu avec ‚ù§Ô∏è pour le voyage
    </footer>

</div>

<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/js/leaflet.js}"></script>
<script th:src="@{/js/roadtrip-map.js}"></script>

</body>
</html>
