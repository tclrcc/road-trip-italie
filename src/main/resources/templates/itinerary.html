<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <title>Mon Itinéraire - RoadTrip</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link th:href="@{/css/index.css}" rel="stylesheet">
    <style>
        .dashed-border {
            border: 2px dashed #0d6efd !important;
            transition: all 0.2s ease-in-out;
        }
        .dashed-border:hover {
            background-color: #f8f9fa;
        }
        .activity-card {
            border-left: 3px solid #ffc107;
        }
        .text-uppercase-small {
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.75rem;
        }
        /* NOUVEAU : Styles pour les filtres et l'animation */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .timeline-item {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 1;
            transform: translateY(0);
        }
        .timeline-item.hidden-item {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
        .filter-glass {
            background: rgba(248, 249, 250, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="bg-light">

<div th:replace="~{fragments/nav :: navbar}"></div>

<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
        <h2 class="fw-bold text-dark mb-0"><i class="fas fa-route text-primary me-2"></i>Fil du Voyage</h2>
        <span class="badge bg-primary rounded-pill px-3 py-2 fs-6 shadow-sm"><span th:text="${days.size()}"></span> Jours</span>
    </div>

    <div class="sticky-top filter-glass pt-3 pb-3 mb-4 z-2" style="top: 0; margin-left: -15px; margin-right: -15px; padding-left: 15px; padding-right: 15px;">
        <div class="d-flex overflow-auto gap-2 pb-1 hide-scrollbar" id="filter-container">
            <button class="btn btn-primary rounded-pill shadow-sm filter-btn flex-shrink-0" data-filter="all">
                <i class="fas fa-globe-europe me-1"></i> Tout le voyage
            </button>
            <button th:each="hub : ${hubs}"
                    class="btn btn-outline-primary rounded-pill filter-btn flex-shrink-0 fw-medium"
                    th:data-filter="${hub}">
                <i class="fas fa-map-marker-alt me-1"></i> <span th:text="${hub}"></span>
            </button>
        </div>
    </div>

    <div class="timeline">
        <div th:each="day : ${days}" class="timeline-item" th:data-hub="${day.hubLocation}">

            <div class="timeline-dot" th:classappend="${day.warningZTL} ? 'ztl-alert' : ''"></div>

            <div class="timeline-content position-relative shadow-sm bg-white rounded-3 p-4 mb-4" th:classappend="${day.warningZTL} ? 'is-ztl border-danger border-opacity-50 border-2' : 'is-hub border-0'">

                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <span class="timeline-date text-uppercase fw-bold text-secondary mb-1 d-block"
                              th:text="${#temporals.format(day.date, 'EEEE d MMMM')}"></span>
                        <h4 class="timeline-title fw-bold mb-0 text-dark" th:text="${day.title}"></h4>
                    </div>

                    <div class="weather-widget text-center ms-2 bg-light p-2 rounded-3"
                         th:if="${weatherMap.get(day.id) != null}"
                         th:with="w=${weatherMap.get(day.id)}">
                        <i th:class="${w.iconClass} + ' fa-lg mb-1 text-info'"></i>
                        <div class="fw-bold small"><span th:text="${#numbers.formatDecimal(w.maxTemp, 1, 0)}"></span>°</div>
                    </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mb-3">
                    <span class="badge bg-light text-dark border">
                        <i class="fas fa-home text-primary"></i> Hub : <span th:text="${day.hubLocation}"></span>
                    </span>
                    <span class="badge bg-light text-dark border">
                        <i class="fas fa-coins text-success"></i> Budget : ~<span th:text="${day.dailyBudget}"></span>€
                    </span>
                    <span th:if="${day.warningZTL}" class="badge bg-danger text-white pulse-animation shadow-sm">
                        <i class="fas fa-ban"></i> ATTENTION ZTL
                    </span>
                </div>

                <p class="text-secondary mb-3 fs-6" th:text="${day.mainActivity}"></p>

                <div th:if="${day.logisticsTip != null && !day.logisticsTip.isEmpty()}" class="alert alert-primary py-2 px-3 small border-0 bg-opacity-10 text-primary mb-3">
                    <i class="fas fa-info-circle me-1"></i> <strong>Note logistique :</strong> <span th:text="${day.logisticsTip}"></span>
                </div>

                <div class="mt-4 bg-light rounded-3 p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold text-muted text-uppercase-small mb-0"><i class="fas fa-list-ul me-1"></i> Programme & Réservations</h6>
                    </div>

                    <div class="list-group mb-3 shadow-sm" th:if="${not #lists.isEmpty(day.activities)}">
                        <div th:each="act : ${day.activities}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3 activity-card">
                            <div>
                                <strong class="text-dark d-block mb-1" th:text="${act.name}">Visite Colisée</strong>
                                <a th:if="${act.bookingUrl != null && !act.bookingUrl.isEmpty()}"
                                   th:href="${act.bookingUrl}" target="_blank" class="text-primary small text-decoration-none bg-primary bg-opacity-10 px-2 py-1 rounded">
                                    <i class="fas fa-external-link-alt"></i> Lien de réservation
                                </a>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-light text-dark border mb-1 d-inline-block" th:if="${act.price != null && act.price > 0}">
                                    <span th:text="${act.price}"></span> €
                                </span>
                                <div class="d-flex align-items-center justify-content-end mt-1">
                                    <span th:if="${act.isPaid}" class="badge bg-success bg-opacity-10 text-success border border-success me-2 small"><i class="fas fa-check"></i> Payé</span>
                                    <span th:if="${!act.isPaid && act.price != null && act.price > 0}" class="badge bg-warning bg-opacity-10 text-warning border border-warning me-2 small">À régler</span>
                                    <a th:href="@{/activity/delete/{id}(id=${act.id})}" class="text-danger small" title="Supprimer l'activité"><i class="fas fa-trash-alt"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-sm btn-outline-primary w-100 dashed-border fw-semibold py-2"
                            data-bs-toggle="modal" th:data-bs-target="'#modalActivity-' + ${day.id}">
                        <i class="fas fa-plus"></i> Ajouter une activité
                    </button>
                </div>

                <div class="mt-4 pt-3 border-top d-flex justify-content-between align-items-center">
                    <a th:href="${day.accommodation != null} ?
                                'https://www.google.com/maps/dir/?api=1&destination=' + ${day.accommodation.latitude} + ',' + ${day.accommodation.longitude} :
                                'https://www.google.com/maps/search/?api=1&query=' + ${day.hubLocation}"
                       target="_blank" class="btn btn-sm btn-dark rounded-pill px-3">
                        <i class="fas fa-location-arrow me-1"></i> Itinéraire GPS
                    </a>

                    <a th:if="${day.accommodation != null && day.accommodation.airbnbLink != null}"
                       th:href="${day.accommodation.airbnbLink}" target="_blank" class="text-danger fs-4 transition" title="Voir sur Airbnb">
                        <i class="fab fa-airbnb"></i>
                    </a>
                </div>
            </div>
        </div>

        <div id="no-results-msg" class="text-center py-5 d-none">
            <i class="fas fa-search-location fa-3x text-muted mb-3 opacity-50"></i>
            <h5 class="text-muted fw-bold">Aucune étape pour ce filtre</h5>
        </div>
    </div>
</div>

<th:block th:each="day : ${days}">
    <div class="modal fade" th:id="'modalActivity-' + ${day.id}" tabindex="-1" aria-hidden="true">
    </div>
</th:block>

<script th:src="@{/js/bootstrap.bundle.min.js}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const filterBtns = document.querySelectorAll('.filter-btn');
        const timelineItems = document.querySelectorAll('.timeline-item');
        const noResultsMsg = document.getElementById('no-results-msg');

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // 1. Gérer le style des boutons (Bouton actif en bleu plein, les autres en contour)
                filterBtns.forEach(b => {
                    b.classList.remove('btn-primary', 'shadow-sm');
                    b.classList.add('btn-outline-primary');
                });
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary', 'shadow-sm');

                const filterValue = btn.getAttribute('data-filter');
                let visibleCount = 0;

                // 2. Filtrer les jours avec animation
                timelineItems.forEach(item => {
                    const itemHub = item.getAttribute('data-hub');

                    if (filterValue === 'all' || itemHub === filterValue) {
                        // Afficher
                        item.style.display = 'block';
                        // Petit délai pour que le display:block s'applique avant l'animation d'opacité
                        setTimeout(() => {
                            item.classList.remove('hidden-item');
                        }, 10);
                        visibleCount++;
                    } else {
                        // Cacher
                        item.classList.add('hidden-item');
                        // Attendre la fin de la transition CSS (0.3s) pour l'enlever du flux DOM
                        setTimeout(() => {
                            if (item.classList.contains('hidden-item')) {
                                item.style.display = 'none';
                            }
                        }, 300);
                    }
                });

                // 3. Afficher le message "Aucun résultat" si besoin (sécurité)
                setTimeout(() => {
                    if(visibleCount === 0) {
                        noResultsMsg.classList.remove('d-none');
                    } else {
                        noResultsMsg.classList.add('d-none');
                    }
                }, 300);
            });
        });
    });
</script>
</body>
</html>
