<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <title>Mon Itinéraire - RoadTrip</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link th:href="@{/css/index.css}" rel="stylesheet">
</head>
<body class="bg-light">

<div th:replace="~{fragments/nav :: navbar}"></div>

<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark"><i class="fas fa-route text-primary me-2"></i>Fil du Voyage</h2>
        <span class="badge bg-primary rounded-pill px-3 py-2"><span th:text="${days.size()}"></span> Jours</span>
    </div>

    <div class="timeline">
        <div th:each="day : ${days}" class="timeline-item">

            <div class="timeline-dot" th:classappend="${day.warningZTL} ? 'ztl-alert' : ''"></div>

            <div class="timeline-content position-relative" th:classappend="${day.warningZTL} ? 'is-ztl' : 'is-hub'">

                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                            <span class="timeline-date text-uppercase fw-bold text-secondary"
                                  th:text="${#temporals.format(day.date, 'EEEE d MMMM')}"></span>
                        <h5 class="timeline-title fw-bold mb-0" th:text="${day.title}"></h5>
                    </div>

                    <div class="weather-widget text-center ms-2"
                         th:if="${weatherMap.get(day.id) != null}"
                         th:with="w=${weatherMap.get(day.id)}">
                        <i th:class="${w.iconClass} + ' fa-lg mb-1'"></i>
                        <div class="fw-bold small"><span th:text="${#numbers.formatDecimal(w.maxTemp, 1, 0)}"></span>°</div>
                    </div>
                </div>

                <p class="text-secondary mb-3" th:text="${day.mainActivity}"></p>

                <div class="mt-3">
                    <h6 class="fw-bold text-muted small uppercase">Activités & Réservations</h6>

                    <div class="list-group mb-2">
                        <div th:each="act : ${day.activities}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-2">
                            <div>
                                <i class="fas fa-ticket-alt text-warning me-2"></i>
                                <span th:text="${act.name}">Visite Colisée</span>
                                <a th:if="${act.bookingUrl != null && !act.bookingUrl.isEmpty()}"
                                   th:href="${act.bookingUrl}" target="_blank" class="ms-2 text-primary small">
                                    <i class="fas fa-external-link-alt"></i> Réserver
                                </a>
                            </div>
                            <div>
                                <span class="badge bg-light text-dark border me-2" th:if="${act.price != null}">
                                    <span th:text="${act.price}">25</span>€
                                </span>
                                <span th:if="${act.isPaid}" class="badge bg-success bg-opacity-10 text-success border border-success me-2 small">Payé</span>
                                <span th:if="${!act.isPaid && act.price != null && act.price > 0}" class="badge bg-warning bg-opacity-10 text-warning border border-warning me-2 small">À régler</span>
                                <a th:href="@{/activity/delete/{id}(id=${act.id})}" class="text-danger small"><i class="fas fa-times"></i></a>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-sm btn-outline-primary w-100 dashed-border"
                            data-bs-toggle="modal" th:data-bs-target="'#modalActivity-' + ${day.id}">
                        <i class="fas fa-plus-circle"></i> Ajouter une activité
                    </button>
                </div>

                <div class="modal fade" th:id="'modalActivity-' + ${day.id}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Ajouter une activité le <span th:text="${#temporals.format(day.date, 'dd/MM')}"></span></h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form th:action="@{/itinerary/{id}/addActivity(id=${day.id})}" method="post">
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Nom de l'activité</label>
                                        <input type="text" name="name" class="form-control" placeholder="Ex: Visite du Duomo" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Prix (€) (Optionnel)</label>
                                        <input type="number" step="0.1" name="price" class="form-control" placeholder="0.00">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Lien de réservation (URL)</label>
                                        <input type="url" name="bookingUrl" class="form-control" placeholder="https://...">
                                    </div>
                                </div>
                                <div class="mb-3 form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="isPaidCheck" name="isPaid">
                                    <label class="form-check-label text-success" for="isPaidCheck">
                                        <i class="fas fa-check-circle"></i> Déjà payé (réservation en ligne effectuée)
                                    </label>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mb-3">
                        <span class="badge bg-light text-dark border">
                            <i class="fas fa-home text-primary"></i> <span th:text="${day.hubLocation}"></span>
                        </span>
                    <span class="badge bg-light text-dark border">
                            <i class="fas fa-coins text-success"></i> ~<span th:text="${day.dailyBudget}"></span>€
                        </span>
                    <span th:if="${day.warningZTL}" class="badge bg-danger text-white pulse-animation">
                            <i class="fas fa-ban"></i> ZONE ZTL
                        </span>
                </div>

                <div th:if="${day.logisticsTip != null && !day.logisticsTip.isEmpty()}" class="alert alert-primary py-2 px-3 small border-0 bg-opacity-10 text-primary">
                    <i class="fas fa-info-circle me-1"></i> <strong>Note :</strong> <span th:text="${day.logisticsTip}"></span>
                </div>

                <div class="mt-3 pt-3 border-top d-flex justify-content-between align-items-center">
                    <a th:href="${day.accommodation != null} ?
                                'https://www.google.com/maps/dir/?api=1&destination=' + ${day.accommodation.latitude} + ',' + ${day.accommodation.longitude} :
                                'https://www.google.com/maps/search/?api=1&query=' + ${day.hubLocation}"
                       target="_blank" class="btn btn-sm btn-outline-dark rounded-pill">
                        <i class="fas fa-location-arrow me-1"></i> GPS
                    </a>

                    <a th:if="${day.accommodation != null && day.accommodation.airbnbLink != null}"
                       th:href="${day.accommodation.airbnbLink}" target="_blank" class="text-danger">
                        <i class="fab fa-airbnb fa-lg"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
