<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <title>Mon Itinéraire - RoadTrip</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link th:href="@{/css/index.css}" rel="stylesheet">
    <style>
        /* Ajout de quelques styles esthétiques pour peaufiner le rendu */
        .dashed-border {
            border: 2px dashed #0d6efd !important;
            transition: all 0.2s ease-in-out;
        }
        .dashed-border:hover {
            background-color: #f8f9fa;
        }
        .activity-card {
            border-left: 3px solid #ffc107;
        }
        .text-uppercase-small {
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.75rem;
        }
    </style>
</head>
<body class="bg-light">

<div th:replace="~{fragments/nav :: navbar}"></div>

<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4 mt-3">
        <h2 class="fw-bold text-dark"><i class="fas fa-route text-primary me-2"></i>Fil du Voyage</h2>
        <span class="badge bg-primary rounded-pill px-3 py-2 fs-6 shadow-sm"><span th:text="${days.size()}"></span> Jours</span>
    </div>

    <div class="timeline">
        <div th:each="day : ${days}" class="timeline-item">

            <div class="timeline-dot" th:classappend="${day.warningZTL} ? 'ztl-alert' : ''"></div>

            <div class="timeline-content position-relative shadow-sm bg-white rounded-3 p-4" th:classappend="${day.warningZTL} ? 'is-ztl border-danger border-opacity-50 border-2' : 'is-hub border-0'">

                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <span class="timeline-date text-uppercase fw-bold text-secondary mb-1 d-block"
                              th:text="${#temporals.format(day.date, 'EEEE d MMMM')}"></span>
                        <h4 class="timeline-title fw-bold mb-0 text-dark" th:text="${day.title}"></h4>
                    </div>

                    <div class="weather-widget text-center ms-2 bg-light p-2 rounded-3"
                         th:if="${weatherMap.get(day.id) != null}"
                         th:with="w=${weatherMap.get(day.id)}">
                        <i th:class="${w.iconClass} + ' fa-lg mb-1 text-info'"></i>
                        <div class="fw-bold small"><span th:text="${#numbers.formatDecimal(w.maxTemp, 1, 0)}"></span>°</div>
                    </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mb-3">
                    <span class="badge bg-light text-dark border">
                        <i class="fas fa-home text-primary"></i> Hub : <span th:text="${day.hubLocation}"></span>
                    </span>
                    <span class="badge bg-light text-dark border">
                        <i class="fas fa-coins text-success"></i> Budget : ~<span th:text="${day.dailyBudget}"></span>€
                    </span>
                    <span th:if="${day.warningZTL}" class="badge bg-danger text-white pulse-animation shadow-sm">
                        <i class="fas fa-ban"></i> ATTENTION ZTL
                    </span>
                </div>

                <p class="text-secondary mb-3 fs-6" th:text="${day.mainActivity}"></p>

                <div th:if="${day.logisticsTip != null && !day.logisticsTip.isEmpty()}" class="alert alert-primary py-2 px-3 small border-0 bg-opacity-10 text-primary mb-3">
                    <i class="fas fa-info-circle me-1"></i> <strong>Note logistique :</strong> <span th:text="${day.logisticsTip}"></span>
                </div>

                <div class="mt-4 bg-light rounded-3 p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold text-muted text-uppercase-small mb-0"><i class="fas fa-list-ul me-1"></i> Programme & Réservations</h6>
                    </div>

                    <div class="list-group mb-3 shadow-sm" th:if="${not #lists.isEmpty(day.activities)}">
                        <div th:each="act : ${day.activities}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3 activity-card">
                            <div>
                                <strong class="text-dark d-block mb-1" th:text="${act.name}">Visite Colisée</strong>
                                <a th:if="${act.bookingUrl != null && !act.bookingUrl.isEmpty()}"
                                   th:href="${act.bookingUrl}" target="_blank" class="text-primary small text-decoration-none bg-primary bg-opacity-10 px-2 py-1 rounded">
                                    <i class="fas fa-external-link-alt"></i> Lien de réservation
                                </a>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-light text-dark border mb-1 d-inline-block" th:if="${act.price != null && act.price > 0}">
                                    <span th:text="${act.price}">25</span> €
                                </span>
                                <div class="d-flex align-items-center justify-content-end mt-1">
                                    <span th:if="${act.isPaid}" class="badge bg-success bg-opacity-10 text-success border border-success me-2 small"><i class="fas fa-check"></i> Payé</span>
                                    <span th:if="${!act.isPaid && act.price != null && act.price > 0}" class="badge bg-warning bg-opacity-10 text-warning border border-warning me-2 small">À régler</span>
                                    <a th:href="@{/activity/delete/{id}(id=${act.id})}" class="text-danger small" title="Supprimer l'activité"><i class="fas fa-trash-alt"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-sm btn-outline-primary w-100 dashed-border fw-semibold py-2"
                            data-bs-toggle="modal" th:data-bs-target="'#modalActivity-' + ${day.id}">
                        <i class="fas fa-plus"></i> Ajouter une activité
                    </button>
                </div>

                <div class="mt-4 pt-3 border-top d-flex justify-content-between align-items-center">
                    <a th:href="${day.accommodation != null} ?
                                'https://www.google.com/maps/dir/?api=1&destination=' + ${day.accommodation.latitude} + ',' + ${day.accommodation.longitude} :
                                'https://www.google.com/maps/search/?api=1&query=' + ${day.hubLocation}"
                       target="_blank" class="btn btn-sm btn-dark rounded-pill px-3">
                        <i class="fas fa-location-arrow me-1"></i> Itinéraire GPS
                    </a>

                    <a th:if="${day.accommodation != null && day.accommodation.airbnbLink != null}"
                       th:href="${day.accommodation.airbnbLink}" target="_blank" class="text-danger fs-4 transition" title="Voir sur Airbnb">
                        <i class="fab fa-airbnb"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block th:each="day : ${days}">
    <div class="modal fade" th:id="'modalActivity-' + ${day.id}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-light border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark">
                        <i class="fas fa-calendar-plus text-primary me-2"></i>Activité du <span th:text="${#temporals.format(day.date, 'dd/MM')}"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <form th:action="@{/itinerary/{id}/addActivity(id=${day.id})}" method="post">
                    <div class="modal-body pt-3">
                        <div class="mb-4">
                            <label class="form-label fw-semibold text-secondary small text-uppercase mb-1">Détails de l'activité</label>
                            <input type="text" name="name" class="form-control" placeholder="Ex: Visite du Duomo, Musée Ferrari..." required>
                        </div>

                        <div class="row mb-4">
                            <div class="col-6">
                                <label class="form-label fw-semibold text-secondary small text-uppercase mb-1">Prix unitaire</label>
                                <div class="input-group">
                                    <input type="number" step="0.1" name="price" class="form-control" placeholder="0.00">
                                    <span class="input-group-text bg-white">€</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-semibold text-info small text-uppercase mb-1" title="Jours avant le voyage">Rappel (Anticipation)</label>
                                <div class="input-group">
                                    <input type="number" name="reminderDaysBefore" class="form-control" placeholder="Ex: 30">
                                    <span class="input-group-text bg-white">Jours</span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-semibold text-secondary small text-uppercase mb-1">Lien de réservation (URL)</label>
                            <input type="url" name="bookingUrl" class="form-control" placeholder="https://...">
                        </div>

                        <div class="bg-success bg-opacity-10 border border-success border-opacity-25 rounded-3 p-3 form-check form-switch d-flex align-items-center justify-content-between">
                            <label class="form-check-label text-success fw-semibold mb-0" th:for="'isPaidCheck-' + ${day.id}">
                                <i class="fas fa-check-circle me-1"></i> Réservation déjà payée en ligne
                            </label>
                            <input class="form-check-input fs-5 m-0" type="checkbox" role="switch" th:id="'isPaidCheck-' + ${day.id}" name="isPaid">
                        </div>
                    </div>

                    <div class="modal-footer border-top-0 pt-0">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary px-4 shadow-sm">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</th:block>

<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
